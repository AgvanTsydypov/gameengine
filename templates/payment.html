{% extends "base.html" %}

{% block title %}Top Up Credits{% endblock %}

{% block extra_head %}
<style>
  /* ==== GRID ==== */
  .credit-packages{
    display:grid;
    gap:24px;
    grid-template-columns:1fr;
    max-width:1000px;margin:2rem auto;padding:0 2rem;
  }
  @media (min-width:640px){ .credit-packages{ grid-template-columns:repeat(2,1fr);} }
  @media (min-width:1024px){ .credit-packages{ grid-template-columns:repeat(4,1fr);} }

  /* ==== DARK CARD ==== */
  .credit-package{
    cursor:pointer;
    border-radius:8px;
    background:#0f1117;                        /* dark card background */
    color:#e6e6ea;                            /* light text */
    padding:24px;
    box-shadow:0 4px 6px rgba(0,0,0,.3), 0 0 0 2px #1a1d27;
    border:2px solid #1a1d27;                 /* dark border */
    transition:all .2s ease;
    position:relative;
    display:flex;flex-direction:column;min-height:280px;
    outline:none;
    text-align:center;
  }
  .credit-package:hover{
    border-color:#1ee4ff;                     /* cyber cyan hover */
    box-shadow:0 8px 25px rgba(0,0,0,.4), 0 0 0 2px #1ee4ff;
    transform:translateY(-2px);
  }
  .credit-package:focus-visible{ 
    outline:2px solid #9d7bff; 
    outline-offset:2px; 
  }

  /* ==== SELECTED STATE (cyber glow) ==== */
  .credit-package.selected{
    border:2px solid #9d7bff;                 /* neon purple border */
    box-shadow:0 0 20px rgba(157,123,255,.3), 0 0 0 3px rgba(157,123,255,.2);
    background:#1a1d27;                       /* slightly lighter dark */
    transform:translateY(-4px);
  }

  /* ==== BADGES ==== */
  .popular-badge{
    position:absolute;top:-12px;left:50%;transform:translateX(-50%);
    background:#ff4d8a;color:#fff;padding:6px 16px;border-radius:20px;
    font-size:12px;font-weight:700;z-index:10;border:2px solid #0f1117;
    box-shadow:0 4px 12px rgba(255,77,138,.6);
  }
  .credit-package.selected .popular-badge{
    background:#9d7bff;box-shadow:0 4px 12px rgba(157,123,255,.6);
    border-color:#1a1d27;
  }
  
  .discount-badge{
    background:#1ee4ff;color:#0a0b10;padding:8px 16px;border-radius:20px;
    font-size:12px;font-weight:700;border:2px solid #1a1d27;
    box-shadow:0 4px 12px rgba(30,228,255,.6);
    text-transform:uppercase;letter-spacing:0.5px;
    margin-top:auto;margin-bottom:8px;text-align:center;
    display:inline-block;width:fit-content;align-self:center;
  }
  .credit-package.selected .discount-badge{
    background:#9d7bff;color:#fff;box-shadow:0 4px 12px rgba(157,123,255,.6);
    border-color:#1a1d27;
  }

  /* ==== TYPO ==== */
  .package-name{font-size:1.125rem;font-weight:600;color:#e6e6ea;margin-bottom:8px;text-align:center;}
  .package-credits{font-size:.875rem;color:#1ee4ff;margin-bottom:12px;font-weight:600;text-align:center;}
  
  .package-pricing{margin-bottom:8px;text-align:center;}
  .package-price{font-size:1rem;color:#e6e6ea;font-weight:600;margin:0;text-align:center;}
  .package-original-price{
    font-size:.8rem;color:#98a0ab;text-decoration:line-through;margin-right:8px;
  }
  .package-savings{
    font-size:.75rem;color:#1ee4ff;font-weight:600;margin-top:4px;text-align:center;
  }

  /* ==== BUY BUTTON ==== */
  .buy-button-container{text-align:center;margin:2rem 0;max-width:600px;margin-left:auto;margin-right:auto;padding:0 2rem;}
  .buy-button{
    width:100%;max-width:400px;border-radius:8px;background:#9d7bff;color:#fff;padding:14px 24px;
    border:2px solid #9d7bff;font-weight:600;font-size:1rem;cursor:pointer;transition:all .2s ease;
    text-decoration:none;display:inline-block;text-transform:uppercase;letter-spacing:1px;
    box-shadow:0 4px 12px rgba(157,123,255,.3);
  }
  .buy-button:hover:not(:disabled){ 
    background:#1ee4ff; 
    border-color:#1ee4ff;
    box-shadow:0 6px 20px rgba(30,228,255,.4);
    transform:translateY(-2px);
  }
  .buy-button:disabled{ 
    background:#1a1d27; 
    border-color:#1a1d27;
    color:#98a0ab;
    cursor:not-allowed; 
    box-shadow:none;
    transform:none;
  }

  /* ==== DARK INFO BLOCKS ==== */
  .current-balance{
    background:#1a1d27;border:2px solid #1ee4ff;border-radius:8px;padding:1rem;margin-bottom:2rem;text-align:center;
    box-shadow:0 0 15px rgba(30,228,255,.2);
    max-width:600px;margin-left:auto;margin-right:auto;
  }
  .balance-amount{font-size:1.5rem;font-weight:700;color:#1ee4ff;text-align:center;}
  
  .payment-info{
    background:#0f1117;border:2px solid #1a1d27;border-radius:8px;padding:1rem;margin-bottom:2rem;text-align:center;
    box-shadow:0 2px 8px rgba(0,0,0,.3);
    max-width:600px;margin-left:auto;margin-right:auto;
  }
  .payment-info h3{margin:0 0 .5rem 0;color:#e6e6ea;font-size:1.1rem;}
  .payment-info p{margin:0;color:#98a0ab;font-size:.9rem;}

  .selection-info{
    background:#1a1d27;border:2px solid #9d7bff;border-radius:8px;padding:1rem;margin:1rem 0;text-align:center;display:none;
    box-shadow:0 0 15px rgba(157,123,255,.2);
    max-width:600px;margin-left:auto;margin-right:auto;
  }
  .selection-info h3{color:#e6e6ea;margin:0 0 .5rem 0;text-align:center;}
  .selection-info p{color:#98a0ab;margin:0;text-align:center;}
  .selection-info.show{display:block;}
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
  <div class="max-w-4xl mx-auto">
    <div class="text-center mb-8" style="text-align:center;width:100%;">
      <h1 style="color:#e6e6ea;font-size:2.5rem;font-weight:bold;margin-bottom:1rem;text-shadow:0 0 10px rgba(157,123,255,.5);text-align:center;width:100%;">Top Up Your Credits</h1>
      <p style="color:#98a0ab;font-size:1.125rem;text-align:center;width:100%;">Choose a credit package to continue creating amazing games with AI</p>
    </div>

    <!-- Current Balance -->
    <div class="current-balance">
      <p style="color:#98a0ab;margin-bottom:0.5rem;text-align:center;">Current Balance</p>
      <div class="balance-amount">{{ user_credits }} Credits</div>
    </div>

    <!-- Payment Info -->
    <div class="payment-info">
      <h3>💳 Secure Payment</h3>
      <p>All payments are processed securely by Stripe. You'll be redirected to Stripe's secure checkout page.</p>
    </div>

     <!-- Credit Packages -->
     <div class="credit-packages" role="radiogroup" aria-label="Credit packages">
       {% for package in credit_packages %}
       <article
         class="credit-package {% if package.popular %}popular{% endif %}"
         role="radio" aria-checked="false" tabindex="0"
         data-package-id="{{ loop.index0 }}"
         data-package-name="{{ package.name }}"
         data-payment-url="{{ package.payment_link_url }}"
         data-credits="{{ package.credits }}"
         data-price="{{ package.price }}"
         onclick="selectPackage(this)"
         onkeydown="handleKeyDown(event, this)">
         
         {% if package.popular %}
           <div class="popular-badge">Most Popular</div>
         {% endif %}
         
         <h3 class="package-name">{{ package.name }}</h3>
         <p class="package-credits">{{ package.credits }} Credits</p>
         
        <div class="package-pricing">
          {% if package.discount_percent > 0 %}
            <div style="text-align:center;">
              <span class="package-original-price">${{ "%.2f"|format(package.original_price) }}</span>
              <span class="package-price">${{ "%.2f"|format(package.price) }}</span>
            </div>
            <div class="package-savings">Save ${{ "%.2f"|format(package.savings) }}</div>
          {% else %}
            <div class="package-price">${{ "%.2f"|format(package.price) }}</div>
          {% endif %}
        </div>
         
         {% if package.discount_percent > 0 %}
           <div class="discount-badge">{{ package.discount_percent }}% OFF</div>
         {% endif %}
       </article>
       {% endfor %}
     </div>

    <!-- Selection Info -->
    <div class="selection-info" id="selection-info">
      <h3>Selected Package</h3>
      <p id="selected-package-info">Please select a package above</p>
    </div>

    <!-- Buy Button -->
    <div class="buy-button-container">
      <button class="buy-button" id="buy-button" disabled onclick="buySelectedPackage()">
        💳 Select a Package First
      </button>
    </div>

    <!-- Additional Info -->
    <div class="payment-info">
      <h3>🔄 Automatic Credit Addition</h3>
      <p>Credits will be automatically added to your account after successful payment. You can start using them immediately!</p>
    </div>
  </div>
</div>

<script>
  let selectedPackage = null;

  function selectPackage(el){
    document.querySelectorAll('.credit-package').forEach(pkg=>{
      pkg.classList.remove('selected');
      pkg.setAttribute('aria-checked','false');
      pkg.setAttribute('tabindex','-1');
    });

    el.classList.add('selected');
    el.setAttribute('aria-checked','true');
    el.setAttribute('tabindex','0');

    selectedPackage = {
      name: el.dataset.packageName,
      paymentUrl: el.dataset.paymentUrl,
      credits: parseInt(el.dataset.credits),
      price: parseFloat(el.dataset.price)
    };

    const info = document.getElementById('selection-info');
    const text = document.getElementById('selected-package-info');
    const btn  = document.getElementById('buy-button');

    info.classList.add('show');
    text.textContent = `${selectedPackage.name} - ${selectedPackage.credits} credits for $${selectedPackage.price.toFixed(2)}`;
    btn.disabled = false;
    btn.textContent = `💳 Buy ${selectedPackage.name} - $${selectedPackage.price.toFixed(2)}`;
  }

  function handleKeyDown(e, el){
    if(e.key === 'Enter' || e.key === ' '){
      e.preventDefault();
      selectPackage(el);
    }
  }

  // Preselect first (or the "popular") package
  document.addEventListener('DOMContentLoaded', ()=>{
    const popular = document.querySelector('.credit-package.popular');
    const first   = document.querySelector('.credit-package');
    selectPackage(popular || first);
  });

  function buySelectedPackage(){
    if(selectedPackage){ window.open(selectedPackage.paymentUrl, '_blank'); }
  }

  // Success banner (проверяем success параметр)
  const urlParams = new URLSearchParams(window.location.search);
  if(urlParams.get('success') === 'true'){
    const successDiv = document.createElement('div');
    successDiv.className = 'payment-info';
    successDiv.style.background = '#d1fae5';
    successDiv.style.borderColor = '#10b981';
    successDiv.style.border = '2px solid #10b981';
    successDiv.style.marginBottom = '2rem';
    
    // Простое сообщение о успехе
    successDiv.innerHTML = '<h3 style="color:#065f46;margin:0 0 0.5rem 0;text-align:center;">✅ Payment Successful!</h3><p style="color:#047857;margin:0;text-align:center;">Your payment was completed successfully! Credits have been added to your account. If you don\'t see the updated balance immediately, please refresh the page.</p>';
    
    const container = document.querySelector('.max-w-6xl');
    if(container) {
      container.insertBefore(successDiv, container.firstChild);
    }
    
    // Убираем success параметр из URL через 5 секунд
    setTimeout(() => {
      const url = new URL(window.location);
      url.searchParams.delete('success');
      window.history.replaceState({}, document.title, url.pathname + url.search);
    }, 5000);
  }
</script>
{% endblock %}
