{% extends "base.html" %}

{% block title %}{{ game.filename[:-5].replace('_', ' ').title() or 'Uploaded Game' }} - AI Game Studio{% endblock %}

{% block content %}
<main>
  <section class="hero">
    <div class="kicker"><span class="dot"></span>PLAYING CREATED GAME</div>
    <h1>{{ game.title or 'Untitled Game' }}</h1>
    <p class="sub">Click to start playing</p>
  </section>

  <section class="section">
    <div style="max-width: 1200px; margin: 0 auto;">
      <!-- Game Container -->
      <div style="border: 2px solid var(--cyber); background: var(--card); padding: 0; margin-bottom: 40px; position: relative;">
        <!-- Fullscreen Controls -->
        <div id="fullscreen-controls" style="position: absolute; top: 10px; right: 10px; z-index: 1000; display: flex; gap: 10px;">
          <button class="btn btn-ghost" id="fullscreen-btn" onclick="toggleFullscreen()" style="font-size: 12px; padding: 8px 12px;">
            <span>‚õ∂ FULLSCREEN</span>
          </button>
          <button class="btn btn-ghost" id="exit-fullscreen-btn" onclick="exitFullscreen()" style="font-size: 12px; padding: 8px 12px; display: none;">
            <span>‚úï EXIT FULLSCREEN</span>
          </button>
        </div>

        <!-- Game Frame Container -->
        <div id="game-container" style="background: var(--bg); min-height: 600px; position: relative; overflow: hidden;">
          <div id="game-loading" style="display: flex; align-items: center; justify-content: center; height: 600px; text-align: center;">
            <div>
              <div style="font-size: 24px; margin-bottom: 16px;">üéÆ</div>
              <h3 style="color: var(--cyber); margin-bottom: 16px;">LOADING GAME...</h3>
              <p style="color: var(--muted); margin-bottom: 20px;">Preparing your HTML game</p>
              <button class="btn btn-cta" onclick="loadGame()"><span>‚ñ∂ START GAME</span></button>
            </div>
          </div>
          
          <iframe id="game-frame" 
                  src="{{ url_for('get_game_content', game_id=game.id) }}" 
                  style="width: 100%; height: 600px; border: none; display: none;"
                  sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-presentation"
                  allowfullscreen>
          </iframe>
        </div>
      </div>

      <!-- Game Info -->

      <!-- Action Buttons -->
      <div style="text-align: center; margin-top: 40px;">
        <a class="btn btn-ghost" href="{{ url_for('my_games') }}" style="margin-right: 10px;"><span>‚Üê BACK TO MY GAMES</span></a>
        <button class="btn btn-ghost" onclick="reloadGame()" style="margin-right: 10px;"><span>üîÑ RELOAD GAME</span></button>
        <button class="btn btn-ghost" onclick="exitFullscreen()" id="exit-fullscreen-action-btn" style="margin-right: 10px; display: none;"><span>‚õ∂ EXIT FULLSCREEN</span></button>
        <a class="btn btn-cta" href="{{ url_for('create_game') }}"><span>+ UPLOAD ANOTHER</span></a>
      </div>
    </div>
  </section>
</main>
{% endblock %}

{% block scripts %}
<script>
let isFullscreen = false;
let gameLoaded = false;

function loadGame() {
  const loadingDiv = document.getElementById('game-loading');
  const gameFrame = document.getElementById('game-frame');
  
  loadingDiv.style.display = 'none';
  gameFrame.style.display = 'block';
  gameLoaded = true;
  
  // Focus the iframe for keyboard input
  gameFrame.focus();
}

function reloadGame() {
  const gameFrame = document.getElementById('game-frame');
  const currentSrc = gameFrame.src;
  gameFrame.src = '';
  setTimeout(() => {
    gameFrame.src = currentSrc;
  }, 100);
}

function toggleFullscreen() {
  if (!isFullscreen) {
    enterFullscreen();
  } else {
    exitFullscreen();
  }
}

function enterFullscreen() {
  const gameContainer = document.getElementById('game-container');
  const fullscreenBtn = document.getElementById('fullscreen-btn');
  const exitFullscreenBtn = document.getElementById('exit-fullscreen-btn');
  const exitFullscreenActionBtn = document.getElementById('exit-fullscreen-action-btn');
  
  if (gameContainer.requestFullscreen) {
    gameContainer.requestFullscreen();
  } else if (gameContainer.webkitRequestFullscreen) {
    gameContainer.webkitRequestFullscreen();
  } else if (gameContainer.msRequestFullscreen) {
    gameContainer.msRequestFullscreen();
  }
  
  isFullscreen = true;
  fullscreenBtn.style.display = 'none';
  exitFullscreenBtn.style.display = 'block';
  if (exitFullscreenActionBtn) exitFullscreenActionBtn.style.display = 'block';
  
  // Adjust iframe height for fullscreen
  const gameFrame = document.getElementById('game-frame');
  if (gameFrame) {
    gameFrame.style.height = '100vh';
  }
}

function exitFullscreen() {
  if (document.exitFullscreen) {
    document.exitFullscreen();
  } else if (document.webkitExitFullscreen) {
    document.webkitExitFullscreen();
  } else if (document.msExitFullscreen) {
    document.msExitFullscreen();
  }
  
  isFullscreen = false;
  const fullscreenBtn = document.getElementById('fullscreen-btn');
  const exitFullscreenBtn = document.getElementById('exit-fullscreen-btn');
  const exitFullscreenActionBtn = document.getElementById('exit-fullscreen-action-btn');
  
  fullscreenBtn.style.display = 'block';
  exitFullscreenBtn.style.display = 'none';
  if (exitFullscreenActionBtn) exitFullscreenActionBtn.style.display = 'none';
  
  // Reset iframe height
  const gameFrame = document.getElementById('game-frame');
  if (gameFrame) {
    gameFrame.style.height = '600px';
  }
  
  // Don't navigate away - just exit fullscreen and continue playing
}

// Listen for fullscreen change events
document.addEventListener('fullscreenchange', handleFullscreenChange);
document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
document.addEventListener('msfullscreenchange', handleFullscreenChange);

function handleFullscreenChange() {
  const isCurrentlyFullscreen = !!(document.fullscreenElement || 
                                  document.webkitFullscreenElement || 
                                  document.msFullscreenElement);
  
  if (!isCurrentlyFullscreen && isFullscreen) {
    // User exited fullscreen via browser controls - just update UI state
    isFullscreen = false;
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    const exitFullscreenBtn = document.getElementById('exit-fullscreen-btn');
    const exitFullscreenActionBtn = document.getElementById('exit-fullscreen-action-btn');
    
    fullscreenBtn.style.display = 'block';
    exitFullscreenBtn.style.display = 'none';
    if (exitFullscreenActionBtn) exitFullscreenActionBtn.style.display = 'none';
    
    // Reset iframe height
    const gameFrame = document.getElementById('game-frame');
    if (gameFrame) {
      gameFrame.style.height = '600px';
    }
  }
}

// Handle ESC key for fullscreen exit
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && isFullscreen) {
    exitFullscreen();
  }
});

// Auto-load game when page loads
document.addEventListener('DOMContentLoaded', function() {
  // Small delay to ensure everything is ready
  setTimeout(() => {
    if (!gameLoaded) {
      loadGame();
    }
  }, 500);
});
</script>

<style>
/* Fullscreen styles */
#game-container:-webkit-full-screen {
  width: 100vw !important;
  height: 100vh !important;
  background: var(--bg);
}

#game-container:-moz-full-screen {
  width: 100vw !important;
  height: 100vh !important;
  background: var(--bg);
}

#game-container:fullscreen {
  width: 100vw !important;
  height: 100vh !important;
  background: var(--bg);
}

/* Ensure iframe takes full space in fullscreen */
#game-container:fullscreen #game-frame {
  height: 100vh !important;
  width: 100vw !important;
}

#game-container:-webkit-full-screen #game-frame {
  height: 100vh !important;
  width: 100vw !important;
}

#game-container:-moz-full-screen #game-frame {
  height: 100vh !important;
  width: 100vw !important;
}

/* Fullscreen controls positioning */
#game-container:fullscreen #fullscreen-controls {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 10000;
}

#game-container:-webkit-full-screen #fullscreen-controls {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 10000;
}

#game-container:-moz-full-screen #fullscreen-controls {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 10000;
}
</style>
{% endblock %}
