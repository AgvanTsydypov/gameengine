{% extends "base.html" %}

{% block title %}Games - AI Game Studio{% endblock %}

{% block content %}
<main>
  <section class="hero">
    <div class="kicker"><span class="dot"></span>DISCOVER ‚Ä¢ PLAY ‚Ä¢ ENJOY</div>
    <h1>COMMUNITY GAMES</h1>
    <p class="sub">Explore amazing games created and shared by our community members</p>
  </section>

  <section class="section">
    {% if games %}
    <div class="games-grid">
      {% for game in games %}
      <div class="game-card">
        {% if game.thumbnail_url %}
        <div class="game-thumbnail">
          <img src="{{ game.thumbnail_url }}" alt="{{ game.title }} preview" loading="lazy">
        </div>
        {% endif %}
        
        <div class="game-card-header">
          <h3 class="game-title">{{ game.title }}</h3>
          <div class="game-meta">
            <span class="game-date">{{ game.created_at[:10] if game.created_at else 'Recent' }}</span>
          </div>
        </div>
        
        <div class="game-card-content">
          <p class="game-description">
            {{ game.description or 'Community created game - ' + game.title }}
          </p>
          <div class="game-stats">
            <span class="game-plays">{{ game.plays }} PLAYS</span>
            <span class="game-likes">
              {% if session.user_id %}
                <button class="like-btn {{ 'liked' if game.is_liked else '' }}" 
                        data-game-id="{{ game.id }}" 
                        aria-label="{{ 'Unlike' if game.is_liked else 'Like' }} {{ game.title }}">
                  <span class="like-icon">{{ '‚ù§Ô∏è' if game.is_liked else 'ü§ç' }}</span>
                  <span class="like-count">{{ game.likes_count }}</span>
                </button>
              {% else %}
                <span class="like-display">
                  <span class="like-icon">ü§ç</span>
                  <span class="like-count">{{ game.likes_count }}</span>
                </span>
              {% endif %}
            </span>
          </div>
        </div>
        
        <div class="game-card-actions">
          <a href="{{ url_for('play_uploaded_game', game_id=game.id) }}" class="btn btn-primary">
            <span>üéÆ PLAY GAME</span>
          </a>
          {% if session.user_id %}
            <button class="btn btn-ghost like-btn-action {{ 'liked' if game.is_liked else '' }}" 
                    data-game-id="{{ game.id }}">
              <span>{{ 'üíî UNLIKE' if game.is_liked else '‚ù§Ô∏è LIKE' }}</span>
            </button>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div style="text-align: center; padding: 60px 20px; color: var(--muted);">
      <h3 style="color: var(--text); margin-bottom: 16px;">NO GAMES YET</h3>
      <p>Be the first to create and share a game with the community!</p>
      {% if session.user_id %}
      <div style="margin-top: 20px;">
        <a class="btn btn-cta" href="{{ url_for('create_game') }}"><span>+ CREATE YOUR FIRST GAME</span></a>
      </div>
      {% else %}
      <div style="margin-top: 20px;">
        <a class="btn btn-cta" href="#" id="no-games-join-btn"><span>+ JOIN AND CREATE A GAME</span></a>
      </div>
      {% endif %}
    </div>
    {% endif %}
  </section>

  {% if not session.user_id %}
  <section class="section">
    <div style="text-align: center; padding: 40px 20px; border: 2px solid var(--line); background: var(--card);">
      <h2 style="color: var(--cyber); margin-bottom: 16px;">READY TO CREATE?</h2>
      <p style="color: var(--muted); margin-bottom: 20px;">Join our community and start building your own games</p>
      <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
        <a class="btn btn-cta" href="#" id="join-create-btn"><span>+ CREATE YOUR GAME</span></a>
      </div>
    </div>
  </section>
  {% endif %}
</main>

<!-- Login Modal -->
<div class="modal-overlay" id="login-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">LOGIN</h3>
      <button class="modal-close" type="button" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body">
      <div id="login-alert"></div>
      <form id="login-form">
        <div class="form-group">
          <label class="form-label" for="login-email">EMAIL</label>
          <input class="form-input" type="email" id="login-email" name="email" required placeholder="your@email.com">
        </div>
        <div class="form-group">
          <label class="form-label" for="login-password">PASSWORD</label>
          <input class="form-input" type="password" id="login-password" name="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <button class="btn btn-cta form-submit" type="submit">
          <span>LOGIN</span>
        </button>
      </form>
      <div class="auth-switch">
        <p>NEW TO THE GALAXY? <a href="#" id="switch-to-register">CREATE ACCOUNT</a></p>
      </div>
    </div>
  </div>
</div>

<!-- Register Modal -->
<div class="modal-overlay" id="register-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">CREATE ACCOUNT</h3>
      <button class="modal-close" type="button" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body">
      <div id="register-alert"></div>
      <form id="register-form">
        <div class="form-group">
          <label class="form-label" for="register-email">EMAIL</label>
          <input class="form-input" type="email" id="register-email" name="email" required placeholder="your@email.com">
        </div>
        <div class="form-group">
          <label class="form-label" for="register-password">PASSWORD</label>
          <input class="form-input" type="password" id="register-password" name="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <div class="form-group">
          <label class="form-label" for="register-confirm-password">CONFIRM PASSWORD</label>
          <input class="form-input" type="password" id="register-confirm-password" name="confirm_password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <button class="btn btn-cta form-submit" type="submit">
          <span>CREATE ACCOUNT</span>
        </button>
      </form>
      <div class="auth-switch">
        <p>ALREADY HAVE AN ACCOUNT? <a href="#" id="switch-to-login">LOGIN</a></p>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Modal functionality (copied from main.js)
  const modals = {
    login: document.getElementById('login-modal'),
    register: document.getElementById('register-modal')
  };

  function openModal(modalId) {
    closeAllModals();
    if (modals[modalId]) {
      modals[modalId].classList.add('active');
    }
  }

  function closeAllModals() {
    Object.values(modals).forEach(modal => {
      if (modal) {
        modal.classList.remove('active');
      }
    });
  }

  // Modal event listeners
  if (modals.login) {
    // Close login modal
    modals.login.querySelector('.modal-close')?.addEventListener('click', closeAllModals);
    modals.login.addEventListener('click', (e) => {
      if (e.target === modals.login) closeAllModals();
    });

    // Switch to register
    document.getElementById('switch-to-register')?.addEventListener('click', (e) => {
      e.preventDefault();
      openModal('register');
    });
  }

  if (modals.register) {
    // Close register modal
    modals.register.querySelector('.modal-close')?.addEventListener('click', closeAllModals);
    modals.register.addEventListener('click', (e) => {
      if (e.target === modals.register) closeAllModals();
    });

    // Switch to login
    document.getElementById('switch-to-login')?.addEventListener('click', (e) => {
      e.preventDefault();
      openModal('login');
    });
  }

  // Close modals with Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeAllModals();
    }
  });

  // Handle auth required buttons
  document.getElementById('join-create-btn')?.addEventListener('click', (e) => {
    e.preventDefault();
    openModal('login');
  });
  
  document.getElementById('no-games-join-btn')?.addEventListener('click', (e) => {
    e.preventDefault();
    openModal('login');
  });

  // Form handling (simplified version for this page)
  const loginForm = document.getElementById('login-form');
  const registerForm = document.getElementById('register-form');

  if (loginForm) {
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(loginForm);
      const submitBtn = loginForm.querySelector('button[type="submit"]');
      const alertContainer = document.getElementById('login-alert');
      
      submitBtn.classList.add('loading');
      submitBtn.disabled = true;

      try {
        const response = await fetch('/login', {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: formData
        });

        const contentType = response.headers.get('content-type');
        
        if (contentType && contentType.includes('application/json')) {
          const result = await response.json();
          
          if (response.ok && result.success) {
            alertContainer.innerHTML = '<div class="alert alert-success">Login successful!</div>';
            closeAllModals();
            setTimeout(() => {
              window.location.reload();
            }, 500);
          } else {
            alertContainer.innerHTML = `<div class="alert alert-error">${result.error || 'Invalid email or password'}</div>`;
          }
        } else {
          const result = await response.text();
          
          if (response.ok && result.includes('Successfully logged in')) {
            alertContainer.innerHTML = '<div class="alert alert-success">Login successful!</div>';
            closeAllModals();
            setTimeout(() => {
              window.location.reload();
            }, 500);
          } else {
            alertContainer.innerHTML = '<div class="alert alert-error">Invalid email or password</div>';
          }
        }
      } catch (error) {
        console.error('Login error:', error);
        alertContainer.innerHTML = '<div class="alert alert-error">Login failed. Please try again.</div>';
      } finally {
        submitBtn.classList.remove('loading');
        submitBtn.disabled = false;
      }
    });
  }

  if (registerForm) {
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(registerForm);
      const password = formData.get('password');
      const confirmPassword = formData.get('confirm_password');
      const submitBtn = registerForm.querySelector('button[type="submit"]');
      const alertContainer = document.getElementById('register-alert');
      
      if (password !== confirmPassword) {
        alertContainer.innerHTML = '<div class="alert alert-error">Passwords do not match</div>';
        return;
      }

      submitBtn.classList.add('loading');
      submitBtn.disabled = true;

      try {
        const response = await fetch('/register', {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: formData
        });

        const contentType = response.headers.get('content-type');
        
        if (contentType && contentType.includes('application/json')) {
          const result = await response.json();
          
          if (response.ok && result.success) {
            alertContainer.innerHTML = '<div class="alert alert-success">Account created successfully! Please log in.</div>';
            setTimeout(() => {
              openModal('login');
            }, 2000);
          } else {
            alertContainer.innerHTML = `<div class="alert alert-error">${result.error || 'Registration failed. Please try again.'}</div>`;
          }
        } else {
          const result = await response.text();
          
          if (response.ok && result.includes('Registration successful')) {
            alertContainer.innerHTML = '<div class="alert alert-success">Account created successfully! Please log in.</div>';
            setTimeout(() => {
              openModal('login');
            }, 2000);
          } else {
            alertContainer.innerHTML = '<div class="alert alert-error">Registration failed. Please try again.</div>';
          }
        }
      } catch (error) {
        console.error('Registration error:', error);
        alertContainer.innerHTML = '<div class="alert alert-error">Registration failed. Please try again.</div>';
      } finally {
        submitBtn.classList.remove('loading');
        submitBtn.disabled = false;
      }
    });
  }
});
</script>
{% endblock %}
