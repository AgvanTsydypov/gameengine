{% extends "base.html" %}

{% block title %}GlitchPeachAI - Games{% endblock %}

{% block content %}
<main>
  <section class="hero">
    <div class="kicker"><span class="dot"></span>DISCOVER ‚Ä¢ PLAY ‚Ä¢ ENJOY</div>
    <h1>COMMUNITY GAMES</h1>
    <p class="sub">Explore amazing games created and shared by our community members</p>
  </section>

  <section class="section">
    <!-- Search and Sort Controls -->
    <div class="search-container">
      <!-- Sort Controls -->
      <div class="sort-controls">
        <form class="sort-form" method="GET" action="{{ url_for('games') }}">
          {% if search_query %}
          <input type="hidden" name="search" value="{{ search_query }}">
          {% endif %}
          <div class="sort-group">
            <label for="sort-select" class="sort-label">SORT BY:</label>
            <select name="sort" id="sort-select" class="sort-select">
              <option value="likes_count" {{ 'selected' if sort_by == 'likes_count' else '' }}>Most Liked</option>
              <option value="created_at" {{ 'selected' if sort_by == 'created_at' else '' }}>Newest First</option>
              <option value="plays_count" {{ 'selected' if sort_by == 'plays_count' else '' }}>Most Played</option>
            </select>
          </div>
        </form>
      </div>
      
      <form class="search-form" method="GET" action="{{ url_for('games') }}">
        <div class="search-input-group">
          <input 
            type="text" 
            name="search" 
            class="search-input" 
            placeholder="Search games by title..." 
            value="{{ search_query or '' }}"
            autocomplete="off"
          >
          <button type="submit" class="search-btn">
            <span class="search-icon">üîç</span>
          </button>
          {% if search_query %}
          <a href="{{ url_for('games') }}" class="clear-search-btn" title="Clear search">
            <span class="clear-icon">‚úï</span>
          </a>
          {% endif %}
        </div>
      </form>
      
      {% if search_query %}
      <div class="search-results-info">
        <span class="search-info">Search results for: <strong>"{{ search_query }}"</strong></span>
        <span class="results-count">{{ games|length }} game{{ 's' if games|length != 1 else '' }} found</span>
      </div>
      {% endif %}
    </div>

    {% if games %}
    <div class="games-grid">
      {% for game in games %}
      <div class="game-card">
        {% if game.thumbnail_url %}
        <div class="game-thumbnail">
          <img src="{{ game.thumbnail_url }}" alt="{{ game.title }} preview" loading="lazy">
        </div>
        {% endif %}
        
        <div class="game-card-header">
          <h3 class="game-title">{{ game.title }}</h3>
          <div class="game-meta">
            <span class="game-author">
              {% if game.user_nickname %}
                by <strong>{{ game.user_nickname }}</strong>
              {% else %}
                by <strong>User {{ game.user_id[:8] if game.user_id else 'Unknown' }}</strong>
              {% endif %}
            </span>
            <span class="game-date">{{ game.created_at[:10] if game.created_at else 'Recent' }}</span>
          </div>
        </div>
        
        <div class="game-card-content">
          <p class="game-description">
            {{ game.description or 'Community created game - ' + game.title }}
          </p>
          <div class="game-stats">
            <span class="game-plays">{{ game.plays }} PLAYS</span>
            <span class="game-likes">
              {% if session.user_id %}
                <button class="like-btn {{ 'liked' if game.is_liked else '' }}" 
                        data-game-id="{{ game.id }}" 
                        aria-label="{{ 'Unlike' if game.is_liked else 'Like' }} {{ game.title }}">
                  <span class="like-icon">{{ '‚ù§Ô∏è' if game.is_liked else 'ü§ç' }}</span>
                  <span class="like-count">{{ game.likes_count }}</span>
                </button>
              {% else %}
                <span class="like-display">
                  <span class="like-icon">ü§ç</span>
                  <span class="like-count">{{ game.likes_count }}</span>
                </span>
              {% endif %}
            </span>
          </div>
        </div>
        
        <div class="game-card-actions">
          <a href="{{ url_for('play_uploaded_game', game_id=game.id) }}" class="btn btn-primary">
            <span>üéÆ PLAY GAME</span>
          </a>
          {% if session.user_id %}
            <button class="btn btn-ghost like-btn-action {{ 'liked' if game.is_liked else '' }}" 
                    data-game-id="{{ game.id }}">
              <span>{{ 'üíî UNLIKE' if game.is_liked else '‚ù§Ô∏è LIKE' }}</span>
            </button>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div style="text-align: center; padding: 60px 20px; color: var(--muted);">
      <h3 style="color: var(--text); margin-bottom: 16px;">NO GAMES YET</h3>
      <p>Be the first to create and share a game with the community!</p>
      {% if session.user_id %}
      <div style="margin-top: 20px;">
        <a class="btn btn-cta" href="{{ url_for('create_game') }}"><span>+ CREATE YOUR FIRST GAME</span></a>
      </div>
      {% else %}
      <div style="margin-top: 20px;">
        <a class="btn btn-cta" href="#" id="no-games-join-btn"><span>+ JOIN AND CREATE A GAME</span></a>
      </div>
      {% endif %}
    </div>
    {% endif %}
  </section>

  {% if not session.user_id %}
  <section class="section">
    <div style="text-align: center; padding: 40px 20px; border: 2px solid var(--line); background: var(--card);">
      <h2 style="color: var(--cyber); margin-bottom: 16px;">READY TO CREATE?</h2>
      <p style="color: var(--muted); margin-bottom: 20px;">Join our community and start building your own games</p>
      <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
        <a class="btn btn-cta" href="#" id="join-create-btn"><span>+ CREATE YOUR GAME</span></a>
      </div>
    </div>
  </section>
  {% endif %}
</main>

<!-- Login Modal -->
<div class="modal-overlay" id="login-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">LOGIN</h3>
      <button class="modal-close" type="button" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body">
      <div id="login-alert"></div>
      <form id="login-form">
        <div class="form-group">
          <label class="form-label" for="login-email">EMAIL</label>
          <input class="form-input" type="email" id="login-email" name="email" required placeholder="your@email.com">
        </div>
        <div class="form-group">
          <label class="form-label" for="login-password">PASSWORD</label>
          <input class="form-input" type="password" id="login-password" name="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <button class="btn btn-cta form-submit" type="submit">
          <span>LOGIN</span>
        </button>
      </form>
      <div class="auth-switch">
        <p>NEW TO THE GALAXY? <a href="#" id="switch-to-register">CREATE ACCOUNT</a></p>
      </div>
    </div>
  </div>
</div>

<!-- Register Modal -->
<div class="modal-overlay" id="register-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">CREATE ACCOUNT</h3>
      <button class="modal-close" type="button" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body">
      <div id="register-alert"></div>
      <form id="register-form">
        <div class="form-group">
          <label class="form-label" for="register-email">EMAIL</label>
          <input class="form-input" type="email" id="register-email" name="email" required placeholder="your@email.com">
        </div>
        <div class="form-group">
          <label class="form-label" for="register-password">PASSWORD</label>
          <input class="form-input" type="password" id="register-password" name="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <div class="form-group">
          <label class="form-label" for="register-confirm-password">CONFIRM PASSWORD</label>
          <input class="form-input" type="password" id="register-confirm-password" name="confirm_password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <button class="btn btn-cta form-submit" type="submit">
          <span>CREATE ACCOUNT</span>
        </button>
      </form>
      <div class="auth-switch">
        <p>ALREADY HAVE AN ACCOUNT? <a href="#" id="switch-to-login">LOGIN</a></p>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Modal functionality (copied from main.js)
  const modals = {
    login: document.getElementById('login-modal'),
    register: document.getElementById('register-modal')
  };

  function openModal(modalId) {
    closeAllModals();
    if (modals[modalId]) {
      modals[modalId].classList.add('active');
    }
  }

  function closeAllModals() {
    Object.values(modals).forEach(modal => {
      if (modal) {
        modal.classList.remove('active');
      }
    });
  }

  // Modal event listeners
  if (modals.login) {
    // Close login modal
    modals.login.querySelector('.modal-close')?.addEventListener('click', closeAllModals);
    modals.login.addEventListener('click', (e) => {
      if (e.target === modals.login) closeAllModals();
    });

    // Switch to register
    document.getElementById('switch-to-register')?.addEventListener('click', (e) => {
      e.preventDefault();
      openModal('register');
    });
  }

  if (modals.register) {
    // Close register modal
    modals.register.querySelector('.modal-close')?.addEventListener('click', closeAllModals);
    modals.register.addEventListener('click', (e) => {
      if (e.target === modals.register) closeAllModals();
    });

    // Switch to login
    document.getElementById('switch-to-login')?.addEventListener('click', (e) => {
      e.preventDefault();
      openModal('login');
    });
  }

  // Close modals with Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeAllModals();
    }
  });

  // Handle auth required buttons
  document.getElementById('join-create-btn')?.addEventListener('click', (e) => {
    e.preventDefault();
    openModal('login');
  });
  
  document.getElementById('no-games-join-btn')?.addEventListener('click', (e) => {
    e.preventDefault();
    openModal('login');
  });

  // Form handling (simplified version for this page)
  const loginForm = document.getElementById('login-form');
  const registerForm = document.getElementById('register-form');

  if (loginForm) {
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(loginForm);
      const submitBtn = loginForm.querySelector('button[type="submit"]');
      const alertContainer = document.getElementById('login-alert');
      
      submitBtn.classList.add('loading');
      submitBtn.disabled = true;

      try {
        const response = await fetch('/login', {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: formData
        });

        const contentType = response.headers.get('content-type');
        
        if (contentType && contentType.includes('application/json')) {
          const result = await response.json();
          
          if (response.ok && result.success) {
            alertContainer.innerHTML = '<div class="alert alert-success">Login successful!</div>';
            closeAllModals();
            setTimeout(() => {
              window.location.reload();
            }, 500);
          } else {
            alertContainer.innerHTML = `<div class="alert alert-error">${result.error || 'Invalid email or password'}</div>`;
          }
        } else {
          const result = await response.text();
          
          if (response.ok && result.includes('Successfully logged in')) {
            alertContainer.innerHTML = '<div class="alert alert-success">Login successful!</div>';
            closeAllModals();
            setTimeout(() => {
              window.location.reload();
            }, 500);
          } else {
            alertContainer.innerHTML = '<div class="alert alert-error">Invalid email or password</div>';
          }
        }
      } catch (error) {
        console.error('Login error:', error);
        alertContainer.innerHTML = '<div class="alert alert-error">Login failed. Please try again.</div>';
      } finally {
        submitBtn.classList.remove('loading');
        submitBtn.disabled = false;
      }
    });
  }

  if (registerForm) {
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(registerForm);
      const password = formData.get('password');
      const confirmPassword = formData.get('confirm_password');
      const submitBtn = registerForm.querySelector('button[type="submit"]');
      const alertContainer = document.getElementById('register-alert');
      
      if (password !== confirmPassword) {
        alertContainer.innerHTML = '<div class="alert alert-error">Passwords do not match</div>';
        return;
      }

      submitBtn.classList.add('loading');
      submitBtn.disabled = true;

      try {
        const response = await fetch('/register', {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: formData
        });

        const contentType = response.headers.get('content-type');
        
        if (contentType && contentType.includes('application/json')) {
          const result = await response.json();
          
          if (response.ok && result.success) {
            alertContainer.innerHTML = '<div class="alert alert-success">Account created successfully! Please log in.</div>';
            setTimeout(() => {
              openModal('login');
            }, 2000);
          } else {
            alertContainer.innerHTML = `<div class="alert alert-error">${result.error || 'Registration failed. Please try again.'}</div>`;
          }
        } else {
          const result = await response.text();
          
          if (response.ok && result.includes('Registration successful')) {
            alertContainer.innerHTML = '<div class="alert alert-success">Account created successfully! Please log in.</div>';
            setTimeout(() => {
              openModal('login');
            }, 2000);
          } else {
            alertContainer.innerHTML = '<div class="alert alert-error">Registration failed. Please try again.</div>';
          }
        }
      } catch (error) {
        console.error('Registration error:', error);
        alertContainer.innerHTML = '<div class="alert alert-error">Registration failed. Please try again.</div>';
      } finally {
        submitBtn.classList.remove('loading');
        submitBtn.disabled = false;
      }
    });
  }
});

// Search functionality
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.querySelector('.search-input');
  const searchForm = document.querySelector('.search-form');

  if (searchInput && searchForm) {
    // Handle Enter key to submit search
    searchInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        searchForm.submit();
      }
    });

    // Focus search input on page load if no search query
    const urlParams = new URLSearchParams(window.location.search);
    if (!urlParams.get('search')) {
      searchInput.focus();
    }
  }
});

// Sort functionality
document.addEventListener('DOMContentLoaded', function() {
  const sortSelect = document.getElementById('sort-select');
  const sortForm = document.querySelector('.sort-form');

  if (sortSelect && sortForm) {
    // Auto-submit form when sort selection changes
    sortSelect.addEventListener('change', function() {
      sortForm.submit();
    });
  }
});
</script>

<style>
.game-meta {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

.game-author {
  color: var(--cyber);
  font-size: 12px;
  font-weight: 500;
}

.game-date {
  color: var(--muted);
  font-size: 12px;
}

/* Sort Controls Styles */
.sort-controls {
  display: flex;
  justify-content: flex-end;
}

.sort-group {
  display: flex;
  align-items: center;
  gap: 12px;
}

.sort-label {
  color: var(--cyber);
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.sort-select {
  background: var(--card);
  border: 2px solid var(--line);
  color: var(--text);
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  min-width: 120px;
}

.sort-select:hover {
  border-color: var(--cyber);
}

.sort-select:focus {
  outline: none;
  border-color: var(--cyber);
  box-shadow: 0 0 0 3px rgba(0, 255, 255, 0.1);
}

.sort-select option {
  background: var(--card);
  color: var(--text);
  padding: 8px;
}

@media (max-width: 768px) {
  .search-container {
    flex-direction: column;
    align-items: stretch;
    gap: 16px;
  }
  
  .search-form {
    width: 100%;
    max-width: 100%;
  }
  
  .sort-controls {
    justify-content: center;
  }
  
  .sort-group {
    flex-direction: column;
    gap: 8px;
  }
  
  .sort-select {
    min-width: 160px;
  }
}
</style>
{% endblock %}
